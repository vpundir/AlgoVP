<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>AlgoTrader Pro</title>
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet"/>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#080a0e;--surface:#0d1117;--surface2:#12181f;
  --border:#1e2830;--border2:#253040;
  --text:#c8d6e5;--dim:#5a6a7a;
  --green:#00c97a;--yellow:#ffd166;--red:#ff6b6b;--purple:#c77dff;--blue:#00d4ff;
  --font:'DM Sans',sans-serif;--mono:'Space Mono',monospace;
}
body.light{
  --bg:#f0f2f5;--surface:#ffffff;--surface2:#f5f7fa;
  --border:#dde3ec;--border2:#c8d0dc;
  --text:#1a2332;--dim:#7a8a9a;
  --green:#00a862;--yellow:#d4900a;--red:#d93025;--purple:#7c3aed;--blue:#0077cc;
}
/* theme toggle button */
.theme-btn{background:transparent;border:1px solid var(--border2);color:var(--dim);width:28px;height:28px;border-radius:6px;cursor:pointer;font-size:14px;display:flex;align-items:center;justify-content:center;transition:all .2s;flex-shrink:0}
.theme-btn:hover{border-color:var(--green);color:var(--green)}
body{background:var(--bg);color:var(--text);font-family:var(--font);overflow:hidden;height:100vh}
.app{display:flex;height:100vh;width:100vw}
/* SIDEBAR */
.sidebar{width:200px;min-width:200px;background:var(--surface);border-right:1px solid var(--border);display:flex;flex-direction:column;padding:20px 0}
.logo{display:flex;align-items:center;gap:10px;padding:0 16px 24px;border-bottom:1px solid var(--border);margin-bottom:16px}
.logo-icon{width:36px;height:36px;background:linear-gradient(135deg,#00ff9d22,#00ff9d44);border:1px solid #00ff9d55;border-radius:8px;display:flex;align-items:center;justify-content:center;font-family:var(--mono);font-size:12px;font-weight:700;color:var(--green)}
.logo-name{font-size:13px;font-weight:600;letter-spacing:.5px}
.logo-sub{font-size:10px;color:var(--green);font-family:var(--mono);letter-spacing:2px}
.nav{flex:1;padding:0 8px;display:flex;flex-direction:column;gap:2px}
.nav-item{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:8px;cursor:pointer;background:transparent;border:none;color:var(--dim);font-family:var(--font);font-size:13px;width:100%;text-align:left;transition:all .15s}
.nav-item:hover{background:var(--surface2);color:var(--text)}
.nav-item.active{background:#00ff9d18;color:var(--green);border:1px solid #00ff9d28}
.nav-icon{font-size:16px;width:20px;text-align:center}
.sidebar-bottom{padding:16px;border-top:1px solid var(--border)}
.ws-dot{width:7px;height:7px;border-radius:50%;display:inline-block;margin-right:6px;transition:all .3s}
.ws-dot.connected{background:var(--green);box-shadow:0 0 6px var(--green)}
.ws-dot.demo{background:var(--yellow);box-shadow:0 0 6px var(--yellow)}
.ws-dot.disconnected{background:var(--red)}
.ws-status{display:flex;align-items:center;font-size:11px;color:var(--dim)}
/* MAIN */
.main{flex:1;display:flex;flex-direction:column;overflow:hidden}
/* TOPBAR */
.topbar{height:58px;min-height:58px;background:var(--surface);border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;padding:0 16px;gap:10px}
.topbar-left{display:flex;align-items:center;gap:12px}
.topbar-right{display:flex;align-items:center;gap:8px;flex-shrink:0}
.nifty-val{font-family:var(--mono);font-size:17px;font-weight:700;transition:color .3s}
.nifty-val.up{color:var(--green)}.nifty-val.down{color:var(--red)}.nifty-val.flat{color:var(--text)}
.nifty-arrow{font-size:11px;margin-left:3px}
.atm-tag{font-size:11px;font-family:var(--mono);padding:2px 7px;border-radius:4px}
.atm-tag.ce{background:#00ff9d15;color:var(--green);border:1px solid #00ff9d33}
.atm-tag.pe{background:#ff6b6b15;color:var(--red);border:1px solid #ff6b6b33}
.status-badge{display:flex;align-items:center;gap:5px}
.status-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
/* Instrument dropdown */
.instrument-sel{background:var(--surface2);border:1px solid var(--border2);color:var(--text);border-radius:7px;padding:6px 10px;font-family:var(--mono);font-size:12px;font-weight:700;cursor:pointer;outline:none;transition:border-color .2s}
.instrument-sel:focus{border-color:var(--green)}
.instrument-sel option{background:var(--surface2)}
/* Mode toggle */
.mode-toggle-wrap{display:flex;background:var(--surface2);border:1px solid var(--border2);border-radius:8px;padding:3px;gap:2px}
.mode-seg{display:flex;align-items:center;gap:5px;padding:5px 11px;border-radius:6px;border:1px solid transparent;cursor:pointer;font-family:var(--mono);font-size:11px;font-weight:700;letter-spacing:1px;transition:all .2s;background:transparent;color:var(--dim)}
.mode-seg-dot{width:6px;height:6px;border-radius:50%;background:currentColor;opacity:.4;transition:all .2s;display:inline-block}
.mode-seg.paper.active{background:#ffd16618;color:var(--yellow);border-color:#ffd16640}
.mode-seg.paper.active .mode-seg-dot{opacity:1;box-shadow:0 0 5px var(--yellow)}
.mode-seg.live.active{background:#ff6b6b18;color:var(--red);border-color:#ff6b6b50}
.mode-seg.live.active .mode-seg-dot{opacity:1;box-shadow:0 0 5px var(--red);animation:pulse 1.2s infinite}
.mode-seg:hover:not(.active){background:#ffffff08;color:var(--text)}
/* Ctrl buttons */
.ctrl-btns{display:flex;gap:5px}
.ctrl-btn{padding:6px 12px;border-radius:6px;border:none;cursor:pointer;font-family:var(--font);font-size:12px;font-weight:600;transition:all .15s}
.ctrl-btn:disabled{opacity:.3;cursor:not-allowed}
.ctrl-btn.start{background:var(--green);color:#000}
.ctrl-btn.start:hover:not(:disabled){box-shadow:0 0 14px #00ff9d55}
.ctrl-btn.sleep{background:var(--surface2);color:var(--dim);border:1px solid var(--border2)}
.ctrl-btn.sleep:hover:not(:disabled){border-color:var(--yellow);color:var(--yellow)}
.ctrl-btn.sleep.sleeping{background:#1a1500;color:var(--yellow);border:1px solid var(--yellow)40}
.ctrl-btn.stop{background:var(--red);color:#fff}
/* CONTENT */
.content{flex:1;overflow-y:auto;padding:16px}
.content::-webkit-scrollbar{width:4px}
.content::-webkit-scrollbar-thumb{background:#222;border-radius:2px}
.page{display:none}.page.active{display:block}
/* CARDS */
.card{background:var(--surface);border:1px solid var(--border);border-radius:12px;overflow:hidden;margin-bottom:14px}
.card-header{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid var(--border)}
.card-title{font-size:13px;font-weight:600;letter-spacing:.3px}
/* Dashboard */
.dash-grid{display:grid;grid-template-columns:1fr 320px;gap:14px}
.dash-main{min-width:0}.dash-side{display:flex;flex-direction:column}
/* Position */
.pos-grid{display:grid;grid-template-columns:1fr 1fr;padding:14px 16px;gap:12px}
.pos-lbl{font-size:10px;color:var(--dim);text-transform:uppercase;letter-spacing:.5px;margin-bottom:3px}
.pos-val{font-size:13px;font-weight:600;font-family:var(--mono)}
.pos-badge{font-size:10px;font-family:var(--mono);background:#00ff9d18;color:var(--green);border:1px solid #00ff9d40;padding:2px 8px;border-radius:4px;font-weight:700}
.signal-card{border-color:#00ff9d30!important;box-shadow:0 0 18px #00ff9d0d}
.hidden{display:none!important}
/* Logs */
.logs-hdr{display:flex;align-items:center;justify-content:space-between;padding:11px 14px;border-bottom:1px solid var(--border)}
.logs-wrap{height:calc(100vh - 224px);overflow-y:auto;padding:8px;display:flex;flex-direction:column;gap:2px;font-family:var(--mono);font-size:11px}
.logs-wrap::-webkit-scrollbar{width:3px}
.logs-wrap::-webkit-scrollbar-thumb{background:#222}
.log-row{display:flex;gap:8px;padding:3px 6px;border-radius:4px;line-height:1.6;align-items:flex-start}
.log-row:hover{background:var(--surface2)}
.log-time{color:var(--dim);min-width:68px;flex-shrink:0}
.log-info{color:#6a8a9a}.log-signal{color:var(--green)}.log-entry-c{color:var(--blue)}
.log-profit{color:var(--green);font-weight:700}.log-loss{color:var(--red);font-weight:700}
.log-sl{color:var(--yellow)}.log-warn{color:var(--yellow)}
.log-del-btn{margin-left:auto;background:transparent;border:none;color:transparent;cursor:pointer;font-size:10px;padding:0 2px;flex-shrink:0;transition:color .15s}
.log-row:hover .log-del-btn{color:var(--dim)}
.log-del-btn:hover{color:var(--red)!important}
/* M.Stock chart iframe */
/* Stat cards */
.stat-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px;margin-bottom:14px}
.stat-card{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:14px 16px}
.stat-lbl{font-size:10px;color:var(--dim);text-transform:uppercase;letter-spacing:.5px;margin-bottom:5px}
.stat-val{font-size:21px;font-weight:700;font-family:var(--mono)}
/* Trade table */
.tbl-wrap{overflow-x:auto}
.trade-tbl{width:100%;border-collapse:collapse;font-size:12px}
.trade-tbl th{padding:10px 12px;text-align:left;color:var(--dim);font-weight:600;font-size:11px;text-transform:uppercase;letter-spacing:.5px;border-bottom:1px solid var(--border);background:var(--surface2)}
.trade-tbl td{padding:9px 12px;border-bottom:1px solid var(--border);vertical-align:middle}
.trade-tbl tr:hover td{background:var(--surface2)}
.reason-badge{font-size:10px;font-family:var(--mono);background:var(--surface2);color:var(--dim);padding:2px 6px;border-radius:4px;border:1px solid var(--border);white-space:nowrap}
.mode-pill{font-size:10px;font-family:var(--mono);padding:2px 7px;border-radius:4px;font-weight:700}
.mode-pill.paper{background:var(--yellow);color:#000}.mode-pill.live{background:var(--red);color:#fff}
.pnl-pos{color:var(--green);font-weight:700;font-family:var(--mono)}
.pnl-neg{color:var(--red);font-weight:700;font-family:var(--mono)}
.pnl-zero{color:var(--dim);font-family:var(--mono)}
.btn-edit{background:transparent;border:1px solid var(--border2);color:var(--dim);padding:3px 7px;border-radius:4px;cursor:pointer;font-size:12px;transition:all .15s}
.btn-edit:hover{border-color:var(--green);color:var(--green)}
.btn-del-row{background:transparent;border:1px solid var(--border2);color:var(--dim);padding:3px 7px;border-radius:4px;cursor:pointer;font-size:12px;margin-left:3px;transition:all .15s}
.btn-del-row:hover{border-color:var(--red);color:var(--red)}
.btn-save{background:var(--green);color:#000;border:none;padding:3px 8px;border-radius:4px;cursor:pointer;font-weight:700}
.btn-cancel-edit{background:var(--surface2);color:var(--dim);border:1px solid var(--border);padding:3px 8px;border-radius:4px;cursor:pointer;margin-left:3px}
.cell-inp{background:var(--surface2);border:1px solid var(--green);color:var(--text);border-radius:4px;padding:3px 6px;font-size:12px;font-family:var(--font);width:100%;min-width:75px;outline:none}
.tbl-filter{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
/* Inputs */
.inp-sm{background:var(--surface2);border:1px solid var(--border2);color:var(--text);border-radius:6px;padding:5px 10px;font-size:12px;font-family:var(--font);outline:none}
.inp-sm:focus{border-color:var(--green)}
.inp-full{background:var(--surface2);border:1px solid var(--border2);color:var(--text);border-radius:6px;padding:8px 12px;font-size:13px;font-family:var(--font);outline:none;width:100%}
.inp-full:focus{border-color:var(--green)}
.btn-outline{background:transparent;border:1px solid var(--border2);color:var(--dim);padding:5px 12px;border-radius:6px;cursor:pointer;font-size:12px;font-family:var(--font)}
.btn-outline:hover{border-color:var(--green);color:var(--green)}
.btn-danger{background:transparent;border:1px solid var(--red);color:var(--red);padding:5px 12px;border-radius:6px;cursor:pointer;font-size:12px;font-family:var(--font);transition:all .15s}
.btn-danger:hover{background:var(--red);color:#fff}
.btn-primary{background:var(--green);color:#000;border:none;padding:10px 24px;border-radius:8px;cursor:pointer;font-family:var(--font);font-size:13px;font-weight:600;margin:14px 18px}
.btn-primary:hover{background:#00e88a}
/* Settings */
.settings-grid{display:grid;grid-template-columns:1fr 1fr}
.settings-sec{padding:16px 18px;border-bottom:1px solid var(--border);border-right:1px solid var(--border)}
.settings-sec:nth-child(even){border-right:none}
.sec-title{font-size:11px;color:var(--green);text-transform:uppercase;letter-spacing:1px;font-weight:700;margin-bottom:12px;font-family:var(--mono)}
.setting-row{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
.setting-lbl{font-size:12px;color:var(--dim)}
.toggle{position:relative;display:inline-block;width:36px;height:20px;cursor:pointer}
.toggle input{opacity:0;width:0;height:0}
.slider{position:absolute;inset:0;background:var(--border2);border-radius:20px;transition:.2s}
.slider::before{content:"";position:absolute;height:14px;width:14px;left:3px;bottom:3px;background:#fff;border-radius:50%;transition:.2s}
input:checked+.slider{background:var(--green)}
input:checked+.slider::before{transform:translateX(16px);background:#000}
/* Toast */
.toast{position:fixed;bottom:24px;right:24px;padding:12px 20px;border-radius:8px;font-size:13px;font-weight:600;z-index:9999;display:none}
.toast.show{display:block;animation:fadeUp .3s ease}
.toast.success{background:var(--green);color:#000}
.toast.warning{background:var(--yellow);color:#000}
.toast.error{background:var(--red);color:#fff}
/* Confirm modal */
.modal-overlay{position:fixed;inset:0;background:#000b;display:none;align-items:center;justify-content:center;z-index:9998}
.modal-overlay.show{display:flex}
.modal-box{background:var(--surface);border:1px solid var(--border2);border-radius:14px;padding:28px 30px;max-width:340px;width:90%;text-align:center}
.modal-box h3{font-size:16px;margin-bottom:10px}
.modal-box p{font-size:13px;color:var(--dim);margin-bottom:24px;line-height:1.5}
.modal-btns{display:flex;gap:10px;justify-content:center}
/* Instrument badge */
.instr-nf{font-size:10px;font-family:var(--mono);background:#00ff9d15;color:var(--green);border:1px solid #00ff9d30;padding:2px 5px;border-radius:3px}
.instr-bnk{font-size:10px;font-family:var(--mono);background:#c77dff15;color:var(--purple);border:1px solid #c77dff30;padding:2px 5px;border-radius:3px}
.instr-btc{font-size:10px;font-family:var(--mono);background:#ffd16615;color:var(--yellow);border:1px solid #ffd16630;padding:2px 5px;border-radius:3px}
.mkt-cell{padding:14px 16px;border-right:1px solid var(--border)}
.mkt-cell:last-child{border-right:none}
.mkt-lbl{font-size:10px;color:var(--dim);text-transform:uppercase;letter-spacing:.5px;margin-bottom:4px;font-family:var(--mono)}
.mkt-val{font-size:15px;font-weight:700;font-family:var(--mono)}
.mkt-sub{font-size:11px;font-family:var(--mono);margin-top:2px}
.spark-bar{flex:1;min-width:6px;border-radius:2px 2px 0 0;transition:height .3s}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}
@keyframes fadeUp{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
#tradeQty:focus{border-color:var(--green)!important}
@media(max-width:900px){
  .sidebar{width:52px;min-width:52px}
  .logo-name,.logo-sub,.nav-label,.sidebar-bottom{display:none}
  .nav-item{justify-content:center;padding:12px}
  .dash-grid{grid-template-columns:1fr}
  .settings-grid{grid-template-columns:1fr}
}
</style>
</head>
<body>
<div class="app">
  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="logo" style="justify-content:space-between">
      <div style="display:flex;align-items:center;gap:10px">
        <div class="logo-icon">AT</div>
        <div><div class="logo-name">AlgoTrader</div><div class="logo-sub">PRO</div></div>
      </div>
      <button class="theme-btn" id="themeToggleBtn" onclick="toggleTheme()" title="Toggle light/dark">ğŸŒ™</button>
    </div>
    <nav class="nav">
      <button class="nav-item active" onclick="showPage('dashboard',this)"><span class="nav-icon">â¬¡</span><span class="nav-label">Dashboard</span></button>
      <button class="nav-item" onclick="showPage('logs',this)"><span class="nav-icon">â‰¡</span><span class="nav-label">Trade Log</span></button>
      <button class="nav-item" onclick="showPage('pnl',this)"><span class="nav-icon">â—ˆ</span><span class="nav-label">PNL</span></button>
      <button class="nav-item" onclick="showPage('settings',this)"><span class="nav-icon">âš™</span><span class="nav-label">Settings</span></button>
    </nav>
    <div class="sidebar-bottom">
      <div class="ws-status"><span class="ws-dot demo" id="wsDot"></span><span id="wsLabel">Demo Mode</span></div>
      <div style="font-size:10px;color:#333;margin-top:4px">v1.1 Â· 21/34 EMA</div>
    </div>
  </aside>

  <!-- MAIN -->
  <main class="main">
    <!-- TOPBAR -->
    <div class="topbar">
      <div class="topbar-left">
        <select class="instrument-sel" id="instrumentSel" onchange="onInstrumentChange()">
          <option value="NIFTY">NIFTY 50</option>
          <option value="BANKNIFTY">BANK NIFTY</option>
          <option value="BTC">BTC/USD</option>
        </select>
        <div style="display:flex;align-items:center;gap:5px">
          <span style="font-size:10px;color:var(--dim)" id="priceLabel">NIFTY</span>
          <span class="nifty-val flat" id="niftyVal">â€”</span>
          <span class="nifty-arrow" id="niftyArrow">â—</span>
        </div>
        <div style="display:flex;gap:5px">
          <span class="atm-tag ce" id="atmCE">CE â€”</span>
          <span class="atm-tag pe" id="atmPE">PE â€”</span>
        </div>
        <!-- Quantity input -->
        <div style="display:flex;align-items:center;gap:5px;border-left:1px solid var(--border);padding-left:12px">
          <span style="font-size:10px;color:var(--dim);font-family:var(--mono)">QTY</span>
          <input id="qtyInput" type="number" min="1" value="75"
            style="width:70px;background:var(--surface2);border:1px solid var(--border2);
                   color:var(--text);border-radius:5px;padding:4px 7px;font-family:var(--mono);
                   font-size:12px;font-weight:700;outline:none;text-align:center"
            onchange="onQtyChange()" onfocus="this.style.borderColor='var(--green)'"
            onblur="this.style.borderColor='var(--border2)'" title="Trade quantity"/>
          <span id="lotInfo" style="font-size:10px;color:var(--dim);font-family:var(--mono)">1 lot</span>
        </div>
      </div>
      <div class="topbar-right">
        <div style="display:flex;align-items:center;gap:5px;border-right:1px solid var(--border);padding-right:10px;margin-right:2px">
          <span style="font-size:10px;color:var(--dim);font-family:var(--mono)">QTY</span>
          <input type="number" id="tradeQty" value="75" min="1" step="1"
            style="width:62px;background:var(--surface2);border:1px solid var(--border2);color:var(--text);border-radius:5px;padding:4px 6px;font-size:12px;font-family:var(--mono);font-weight:700;outline:none;text-align:center"
            oninput="onQtyChange()" title="Quantity to trade"/>
          <span style="font-size:10px;color:var(--dim);font-family:var(--mono)" id="lotLabel">= 1 lot</span>
        </div>
        <div class="status-badge">
          <div class="status-dot" id="statusDot" style="background:var(--red)"></div>
          <span id="statusText" style="color:var(--red);font-family:var(--mono);font-size:12px;font-weight:700;letter-spacing:1px">STOPPED</span>
        </div>
        <div class="mode-toggle-wrap">
          <button class="mode-seg paper active" id="btnPaper" onclick="setMode('PAPER')"><span class="mode-seg-dot"></span>PAPER</button>
          <button class="mode-seg live" id="btnLive" onclick="setMode('LIVE')"><span class="mode-seg-dot"></span>LIVE</button>
        </div>
        <div class="ctrl-btns">
          <button class="ctrl-btn start" id="btnStart" onclick="botControl('START')">â–¶ Start</button>
          <button class="ctrl-btn sleep" id="btnSleep" onclick="toggleSleep()" title="Sleep halts price fetching; Wake resumes it">ğŸŒ™ Sleep</button>
          <button class="ctrl-btn stop"  id="btnStop"  onclick="botControl('STOP')"  disabled>â¹ Stop</button>
        </div>
      </div>
    </div>

    <!-- PAGES -->
    <div class="content">

      <!-- DASHBOARD -->
      <div class="page active" id="page-dashboard">
        <div class="dash-grid">
          <div class="dash-main">
            <!-- M.Stock Live Chart -->
                 <!-- Market Data Panel -->
            <div class="card">
              <div class="card-header">
                <span class="card-title" id="chartTitle">NIFTY 50 â€” Market Data</span>
                <div style="display:flex;align-items:center;gap:8px">
                  <span id="marketStatusBadge" style="font-size:11px;font-family:var(--mono);color:var(--yellow)">â— CLOSED (Last Close)</span>
                  <span style="font-size:11px;color:var(--dim)" id="lastUpdateTime">Fetching...</span>
                  <button onclick="fetchRealPrice()" style="background:transparent;border:1px solid var(--border2);color:var(--dim);padding:2px 8px;border-radius:4px;cursor:pointer;font-size:11px;font-family:var(--mono)" title="Refresh now">â†»</button>
                </div>
              </div>
              <div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr 1fr;border-bottom:1px solid var(--border)">
                <div class="mkt-cell">
                  <div class="mkt-lbl">LTP</div>
                  <div class="mkt-val" id="mv_ltp" style="font-size:20px">â€”</div>
                  <div class="mkt-sub" id="mv_chg" style="color:var(--dim)">â€”</div>
                </div>
                <div class="mkt-cell">
                  <div class="mkt-lbl">Day High</div>
                  <div class="mkt-val" id="mv_high" style="color:var(--green)">â€”</div>
                </div>
                <div class="mkt-cell">
                  <div class="mkt-lbl">Day Low</div>
                  <div class="mkt-val" id="mv_low" style="color:var(--red)">â€”</div>
                </div>
                <div class="mkt-cell">
                  <div class="mkt-lbl">Prev Close</div>
                  <div class="mkt-val" id="mv_prev">â€”</div>
                </div>
                <div class="mkt-cell">
                  <div class="mkt-lbl">Open</div>
                  <div class="mkt-val" id="mv_open">â€”</div>
                </div>
              </div>
              <div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr;border-bottom:1px solid var(--border)">
                <div class="mkt-cell">
                  <div class="mkt-lbl">EMA 21</div>
                  <div class="mkt-val" id="mv_ema21" style="color:var(--blue)">â€”</div>
                </div>
                <div class="mkt-cell">
                  <div class="mkt-lbl">EMA 34</div>
                  <div class="mkt-val" id="mv_ema34" style="color:var(--yellow)">â€”</div>
                </div>
                <div class="mkt-cell">
                  <div class="mkt-lbl">VWAP</div>
                  <div class="mkt-val" id="mv_vwap" style="color:var(--purple)">â€”</div>
                </div>
                <div class="mkt-cell">
                  <div class="mkt-lbl">EMA Signal</div>
                  <div class="mkt-val" id="mv_ema_sig" style="font-size:12px">â€”</div>
                </div>
              </div>
              <div style="padding:10px 16px;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px;border-bottom:1px solid var(--border)">
                <span style="font-size:11px;color:var(--dim);font-family:var(--mono)">LAST 5-MIN CANDLE</span>
                <div style="display:flex;gap:16px;font-family:var(--mono);font-size:12px">
                  <span>O: <span id="c_open" style="color:var(--text)">â€”</span></span>
                  <span>H: <span id="c_high" style="color:var(--green)">â€”</span></span>
                  <span>L: <span id="c_low" style="color:var(--red)">â€”</span></span>
                  <span>C: <span id="c_close" style="color:var(--text)">â€”</span></span>
                </div>
                <div id="candlePattern" style="font-size:11px;font-family:var(--mono);color:var(--yellow)"></div>
              </div>
              <div style="padding:10px 16px 14px">
                <div style="font-size:10px;color:var(--dim);margin-bottom:6px;font-family:var(--mono)">LAST 20 CANDLES (5-MIN SPARKLINE)</div>
                <div id="sparkBars" style="display:flex;align-items:flex-end;gap:2px;height:48px"></div>
              </div>
            </div>
            <!-- Signal card -->
            <div class="card signal-card hidden" id="signalCard">
              <div class="card-header">
                <span class="card-title">ğŸ¯ Signal Detected</span>
                <span class="pos-badge">WAITING ENTRY</span>
              </div>
              <div class="pos-grid" id="signalGrid"></div>
            </div>
            <!-- Position card -->
            <div class="card" id="posCard">
              <div class="card-header">
                <span class="card-title">Active Position</span>
                <span class="pos-badge hidden" id="posBadge">LONG</span>
              </div>
              <div id="posEmpty" style="padding:28px;text-align:center;color:var(--dim)">No open position</div>
              <div class="pos-grid hidden" id="posGrid"></div>
            </div>
          </div>
          <div class="dash-side">
            <div class="card" style="flex:1;display:flex;flex-direction:column;margin-bottom:0">
              <div class="logs-hdr">
                <span class="card-title">Live Logs</span>
                <div style="display:flex;align-items:center;gap:8px">
                  <span style="font-size:11px;color:var(--green);animation:pulse 1.5s infinite">â— LIVE</span>
                  <button class="btn-danger" style="padding:3px 9px;font-size:11px" onclick="confirmAction('clearLogs','Clear all log entries?')">Clear</button>
                </div>
              </div>
              <div class="logs-wrap" id="logsPanel"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- TRADE LOG -->
      <div class="page" id="page-logs">
        <div class="card">
          <div class="card-header">
            <span class="card-title">Trade Log</span>
            <div class="tbl-filter">
              <input type="date" class="inp-sm" id="filterDate" onchange="renderTradeTable()"/>
              <select class="inp-sm" id="filterMode" onchange="renderTradeTable()">
                <option value="">All Modes</option>
                <option value="PAPER">Paper</option>
                <option value="LIVE">Live</option>
              </select>
              <select class="inp-sm" id="filterInstr" onchange="renderTradeTable()">
                <option value="">All Instruments</option>
                <option value="NIFTY">Nifty</option>
                <option value="BANKNIFTY">BankNifty</option>
                <option value="BTC">BTC</option>
              </select>
              <button class="btn-outline" onclick="exportCSV()">â†“ CSV</button>
              <button class="btn-danger" onclick="confirmAction('deleteAll','Delete ALL trade records permanently?')">ğŸ—‘ Delete All</button>
            </div>
          </div>
          <div class="tbl-wrap">
            <table class="trade-tbl">
              <thead>
                <tr><th>#</th><th>Instrument</th><th>Entry Time</th><th>Entry â‚¹</th><th>Exit Time</th><th>Exit â‚¹</th><th>Reason</th><th>PNL</th><th>Mode</th><th>Actions</th></tr>
              </thead>
              <tbody id="tradeTbody"></tbody>
            </table>
            <div id="noTrades" style="padding:40px;text-align:center;color:var(--dim);display:none">No trades found</div>
          </div>
        </div>
      </div>

      <!-- PNL -->
      <div class="page" id="page-pnl">
        <div class="stat-grid" id="statGrid"></div>
        <div class="card">
          <div class="card-header">
            <span class="card-title">Daily PNL</span>
            <select class="inp-sm" id="pnlInstrFilter" onchange="renderPNL()">
              <option value="">All Instruments</option>
              <option value="NIFTY">Nifty</option>
              <option value="BANKNIFTY">BankNifty</option>
              <option value="BTC">BTC/USD</option>
            </select>
          </div>
          <div style="height:240px;padding:10px 16px 16px"><canvas id="pnlChart"></canvas></div>
        </div>
      </div>

      <!-- SETTINGS -->
      <div class="page" id="page-settings">
        <div class="card">
          <div class="card-header"><span class="card-title">Settings</span></div>
          <div class="settings-grid">
            <div class="settings-sec">
              <div class="sec-title">API Keys</div>
              <div class="setting-row"><span class="setting-lbl">M.Stock API Key</span><input class="inp-full" type="password" id="s_apikey" placeholder="Enter key..."/></div>
              <div class="setting-row"><span class="setting-lbl">Demo Mode</span><label class="toggle"><input type="checkbox" id="s_demo" checked/><span class="slider"></span></label></div>
            </div>
            <div class="settings-sec">
              <div class="sec-title">Risk Management</div>
              <div class="setting-row"><span class="setting-lbl">Default Qty (Nifty)</span><input class="inp-sm" type="number" id="s_qty_nifty" value="75"/></div>
              <div class="setting-row"><span class="setting-lbl">Default Qty (BankNifty)</span><input class="inp-sm" type="number" id="s_qty_bnk" value="30"/></div>
              <div class="setting-row"><span class="setting-lbl">Default Qty (BTC)</span><input class="inp-sm" type="number" id="s_qty_btc" value="1"/></div>
              <div class="setting-row"><span class="setting-lbl">Max SL Points</span><input class="inp-sm" type="number" id="s_maxsl" value="20"/></div>
            </div>
            <div class="settings-sec">
              <div class="sec-title">Trading Hours</div>
              <div class="setting-row"><span class="setting-lbl">Entry Start</span><input class="inp-sm" type="time" id="s_start" value="09:25"/></div>
              <div class="setting-row"><span class="setting-lbl">Entry End</span><input class="inp-sm" type="time" id="s_end" value="15:00"/></div>
              <div class="setting-row"><span class="setting-lbl">Exit All At</span><input class="inp-sm" type="time" id="s_exit" value="15:10"/></div>
            </div>
            <div class="settings-sec">
              <div class="sec-title">Filters</div>
              <div class="setting-row"><span class="setting-lbl">VWAP Signal Filter</span><label class="toggle"><input type="checkbox" id="s_vwap_sig" checked/><span class="slider"></span></label></div>
              <div class="setting-row"><span class="setting-lbl">VWAP Exit</span><label class="toggle"><input type="checkbox" id="s_vwap_exit" checked/><span class="slider"></span></label></div>
              <div class="setting-row"><span class="setting-lbl">Mon/Tue Next Week Expiry</span><label class="toggle"><input type="checkbox" id="s_nextweek" checked/><span class="slider"></span></label></div>
            </div>
            <div class="settings-sec">
              <div class="sec-title">Paper Trading</div>
              <div class="setting-row"><span class="setting-lbl">Capital (â‚¹)</span><input class="inp-sm" type="number" id="s_capital" value="500000"/></div>
              <div class="setting-row"><span class="setting-lbl">Slippage (pts)</span><input class="inp-sm" type="number" id="s_slip" value="1"/></div>
            </div>
            <div class="settings-sec">
              <div class="sec-title">Backend URL</div>
              <div class="setting-row" style="flex-direction:column;align-items:flex-start;gap:8px">
                <span class="setting-lbl">Your Railway URL</span>
                <input class="inp-full" type="text" id="s_backendUrl" placeholder="https://xxxx.railway.app"/>
              </div>
            </div>
          </div>
          <button class="btn-primary" onclick="saveSettings()">Save Settings</button>
        </div>
      </div>

    </div>
  </main>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<!-- CONFIRM MODAL -->
<div class="modal-overlay" id="modalOverlay" onclick="if(event.target===this)closeModal()">
  <div class="modal-box">
    <h3 id="modalTitle">Confirm</h3>
    <p id="modalMsg">Are you sure?</p>
    <div class="modal-btns">
      <button class="btn-outline" onclick="closeModal()">Cancel</button>
      <button class="btn-danger" id="modalConfirmBtn">Confirm</button>
    </div>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INSTRUMENT CONFIG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const INSTRUMENTS = {
  NIFTY: {
    label:'NIFTY 50', priceLabel:'NIFTY', atmStep:50, basePrice:25571,
    tvSymbol:'NSE:NIFTY50', defaultQty:75, lotSize:75
  },
  BANKNIFTY: {
    label:'BANK NIFTY', priceLabel:'BANKNIFTY', atmStep:100, basePrice:54000,
    tvSymbol:'NSE:BANKNIFTY', defaultQty:30, lotSize:30
  },
  BTC: {
    label:'BTC/USD', priceLabel:'BTC', atmStep:500, basePrice:95000,
    tvSymbol:'BINANCE:BTCUSDT', defaultQty:1, lotSize:1
  }
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let BACKEND_URL = localStorage.getItem('backendUrl') || '';
let isDarkTheme = true;
let WS_URL      = BACKEND_URL ? BACKEND_URL.replace('https','wss').replace('http','ws')+'/ws' : '';
let botStatus   = 'STOPPED';
let sleeping    = false;  // sleep mode halts data fetching
let mode        = 'PAPER';
let instrument  = 'NIFTY';
let niftyPrice  = 0;
let prevNifty   = 0;
let activePos   = null;
let currentSig  = null;
let trades      = generateDemoTrades();
let ws          = null;
let wsConnected = false;
let editingId   = null;
let pnlChartInst= null;
let simTick     = 0;
let isSleeping  = false;       // sleep mode halts price fetch & sim
let tradeQty    = 75;          // default Nifty lot size â€” updated per instrument

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DEMO DATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function generateDemoTrades(){
  const reasons=['SL_HIT','TRAILING_SL','VWAP_EXIT','SHOOTING_STAR_EXIT','TIME_EXIT_3_10','SWING_LOW_EXIT','MANUAL_EXIT'];
  const instrs=['NIFTY','BANKNIFTY'];
  return Array.from({length:24},(_,i)=>{
    const instr=instrs[i%2], cfg=INSTRUMENTS[instr];
    const d=new Date(); d.setDate(d.getDate()-Math.floor(i/2));
    const entryT=new Date(d.getFullYear(),d.getMonth(),d.getDate(),9+Math.floor(Math.random()*5),Math.floor(Math.random()*55));
    const exitT=new Date(entryT.getTime()+(30+Math.random()*90)*60000);
    const ep=cfg.basePrice+(Math.random()-.5)*200;
    const pnl=(Math.random()>.42?1:-1)*(Math.random()*25+3)*130;
    return{id:i+1,instrument:instr,time_of_entry:entryT.toISOString(),entry_price:+ep.toFixed(2),
      time_of_exit:exitT.toISOString(),exit_price:+(ep+pnl/130).toFixed(2),
      reason_of_exit:reasons[Math.floor(Math.random()*reasons.length)],
      pnl:+pnl.toFixed(2),mode:Math.random()>.3?'PAPER':'LIVE',quantity:tradeQty};
  }).sort((a,b)=>new Date(b.time_of_entry)-new Date(a.time_of_entry));
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UTILS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const fmt  = n  => (+(n||0)).toLocaleString('en-IN',{maximumFractionDigits:2});
const fmtT = iso=> iso?new Date(iso).toLocaleTimeString('en-IN',{hour:'2-digit',minute:'2-digit'}):'â€”';
const fmtD = iso=> iso?new Date(iso).toLocaleDateString('en-IN',{day:'2-digit',month:'short'}):'â€”';

function toggleTheme(){
  isDarkTheme = !isDarkTheme;
  document.body.classList.toggle('light', !isDarkTheme);
  document.getElementById('themeToggleBtn').textContent = isDarkTheme ? 'ğŸŒ™' : 'â˜€ï¸';
  localStorage.setItem('theme', isDarkTheme ? 'dark' : 'light');
}

function onQtyChange(){
  const inp = document.getElementById('qtyInput');
  const val = parseInt(inp.value);
  if(isNaN(val) || val < 1){ inp.value = tradeQty; return; }
  tradeQty = val;
  const cfg = INSTRUMENTS[instrument];
  const lots = cfg.lotSize ? (val/cfg.lotSize).toFixed(1) : val;
  document.getElementById('lotInfo').textContent = lots + ' lot' + (lots==1?'':'s');
}

function toggleSleep(){
  isSleeping = !isSleeping;
  const btn = document.getElementById('btnSleep');
  if(isSleeping){
    btn.textContent = 'â˜€ï¸ Wake';
    btn.classList.add('sleeping');
    addLog('warn','ğŸ˜´ Sleep mode â€” price fetching paused');
    showToast('Sleep mode â€” fetching paused','warning');
  } else {
    btn.textContent = 'ğŸŒ™ Sleep';
    btn.classList.remove('sleeping');
    addLog('info','â˜€ï¸ Woke up â€” resuming price fetch');
    showToast('Resumed price fetching');
    fetchRealPrice(); // fetch immediately on wake
  }
}
// Always compute in IST (UTC+5:30) â€” browser timezone doesn't matter
function getIST() {
  const now = new Date();
  const istOffset = 5.5 * 60; // IST is UTC+5:30 in minutes
  const utcMs = now.getTime() + now.getTimezoneOffset() * 60000;
  return new Date(utcMs + istOffset * 60000);
}
const isMarketOpen = () => {
  if(instrument === 'BTC') return true; // BTC trades 24/7
  const ist = getIST();
  const day = ist.getDay(); // 0=Sun,1=Mon,...,6=Sat
  const h   = ist.getHours();
  const m   = ist.getMinutes();
  const afterOpen  = (h > 9)  || (h === 9  && m >= 15);
  const beforeClose= (h < 15) || (h === 15 && m <= 30);
  return day >= 1 && day <= 5 && afterOpen && beforeClose;
};
const isWeekendIST = () => { const d = getIST().getDay(); return d===0||d===6; };

function showToast(msg,type='success'){
  const t=document.getElementById('toast');
  t.textContent=msg; t.className=`toast show ${type}`;
  setTimeout(()=>t.className='toast',3000);
}

// â”€â”€ MODAL â”€â”€
function confirmAction(action, msg, tradeId=null){
  document.getElementById('modalTitle').textContent = action==='clearLogs'?'Clear Logs':action==='deleteAll'?'Delete All Trades':'Delete Trade';
  document.getElementById('modalMsg').textContent   = msg;
  document.getElementById('modalConfirmBtn').onclick = ()=>{ executeAction(action,tradeId); closeModal(); };
  document.getElementById('modalOverlay').classList.add('show');
}
function closeModal(){ document.getElementById('modalOverlay').classList.remove('show'); }
function executeAction(action,tradeId){
  if(action==='clearLogs'){ document.getElementById('logsPanel').innerHTML=''; addLog('info','Logs cleared.'); }
  else if(action==='deleteAll'){ trades=[]; renderTradeTable(); showToast('All trades deleted','warning'); }
  else if(action==='deleteTrade'){
    trades=trades.filter(t=>t.id!==tradeId);
    if(wsConnected) fetch(`${BACKEND_URL}/api/trades/${tradeId}`,{method:'DELETE'}).catch(()=>{});
    renderTradeTable(); showToast('Trade deleted');
  }
}

// â”€â”€ LOGS â”€â”€
// FIX #2: trading logs (profit/loss/signal/entry) only fire when bot is RUNNING
function addLog(type,msg){
  const tradingTypes=['signal','entry-c','profit','loss','sl'];
  if(tradingTypes.includes(type) && botStatus!=='RUNNING') return;
  const panel=document.getElementById('logsPanel');
  const time=new Date().toLocaleTimeString('en-IN');
  const uid='lg_'+Date.now()+'_'+Math.random().toString(36).slice(2,6);
  const row=document.createElement('div');
  row.className='log-row'; row.id=uid;
  row.innerHTML=`<span class="log-time">${time}</span><span class="log-${type}">${msg}</span><button class="log-del-btn" onclick="document.getElementById('${uid}').remove()" title="Remove">âœ•</button>`;
  panel.appendChild(row);
  panel.scrollTop=panel.scrollHeight;
  while(panel.children.length>300) panel.removeChild(panel.firstChild);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NAV
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showPage(id,btn){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(b=>b.classList.remove('active'));
  document.getElementById('page-'+id).classList.add('active');
  if(btn) btn.classList.add('active');
  if(id==='pnl') renderPNL();
  if(id==='logs') renderTradeTable();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INSTRUMENT CHANGE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function onInstrumentChange(){
  instrument=document.getElementById('instrumentSel').value;
  const cfg=INSTRUMENTS[instrument];
  document.getElementById('chartTitle').textContent=`${cfg.label} â€” Market Data`;
  document.getElementById('priceLabel').textContent=cfg.priceLabel;
  // Update qty to instrument default
  tradeQty = cfg.defaultQty || 1;
  document.getElementById('qtyInput').value = tradeQty;
  document.getElementById('lotInfo').textContent = '1 lot';
  if(wsConnected) fetch(`${BACKEND_URL}/api/bot/instrument/${instrument}`,{method:'POST'}).catch(()=>{});
  niftyPrice=0; prevNifty=0; updateNiftyUI();
  document.getElementById('lastUpdateTime').textContent='Fetching...';
  fetchRealPrice();
  setDefaultQty();
  addLog('info',`ğŸ“Š Switched to ${cfg.label}`);
  showToast(`Instrument: ${cfg.label}`);
  if(botStatus==='RUNNING'){ botControl('STOP'); showToast('Bot stopped â€” restart for new instrument','warning'); }
}

function updateATM(){
  const cfg=INSTRUMENTS[instrument];
  const atm=Math.round(niftyPrice/cfg.atmStep)*cfg.atmStep;
  if(instrument==='BTC'){
    document.getElementById('atmCE').textContent=`R ${(atm+cfg.atmStep).toLocaleString()}`;
    document.getElementById('atmPE').textContent=`S ${(atm-cfg.atmStep).toLocaleString()}`;
  } else {
    document.getElementById('atmCE').textContent=`CE ${atm}`;
    document.getElementById('atmPE').textContent=`PE ${atm}`;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BOT CONTROL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function botControl(action){
  if(wsConnected){ try{await fetch(`${BACKEND_URL}/api/bot/${action.toLowerCase()}`,{method:'POST'});}catch(e){} }
  botStatus=action==='START'?'RUNNING':action==='PAUSE'?'PAUSED':'STOPPED';
  updateStatusUI();
  const msgs={START:`ğŸš€ Bot started â€” ${INSTRUMENTS[instrument].label} Â· ${mode}`,PAUSE:'â¸ Bot paused',STOP:'â¹ Bot stopped'};
  const types={START:'success',PAUSE:'warning',STOP:'error'};
  // System msgs always show regardless of botStatus gate
  const panel=document.getElementById('logsPanel');
  const time=new Date().toLocaleTimeString('en-IN');
  const uid='lg_sys_'+Date.now();
  const row=document.createElement('div');row.className='log-row';row.id=uid;
  row.innerHTML=`<span class="log-time">${time}</span><span class="log-info">${msgs[action]}</span><button class="log-del-btn" onclick="document.getElementById('${uid}').remove()">âœ•</button>`;
  panel.appendChild(row); panel.scrollTop=panel.scrollHeight;
  showToast(msgs[action],types[action]);
  if(action==='STOP'){activePos=null;currentSig=null;updatePositionUI();updateSignalUI();}
}

function updateStatusUI(){
  const cols={RUNNING:'var(--green)',PAUSED:'var(--yellow)',STOPPED:'var(--red)'};
  const dot=document.getElementById('statusDot'), txt=document.getElementById('statusText');
  dot.style.background=cols[botStatus];
  dot.style.boxShadow=botStatus==='RUNNING'?`0 0 8px ${cols[botStatus]}`:'none';
  dot.style.animation=botStatus==='RUNNING'?'pulse 1.5s infinite':'none';
  txt.style.color=cols[botStatus]; txt.textContent=botStatus;
  document.getElementById('btnStart').disabled=botStatus==='RUNNING';
  document.getElementById('btnSleep').disabled=botStatus!=='RUNNING';
  document.getElementById('btnStop').disabled=botStatus==='STOPPED';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MODE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function setMode(m){
  if(m===mode) return;
  if(m==='LIVE'&&!document.getElementById('s_apikey').value&&!BACKEND_URL){
    showToast('Add API key + Backend URL in Settings first!','error'); return;
  }
  mode=m;
  document.getElementById('btnPaper').classList.toggle('active',m==='PAPER');
  document.getElementById('btnLive').classList.toggle('active',m==='LIVE');
  if(wsConnected){try{await fetch(`${BACKEND_URL}/api/bot/mode/${m}`,{method:'POST'});}catch(e){}}
  addLog('info',`Switched to ${m} mode`);
  showToast(`${m} mode active`,m==='LIVE'?'error':'warning');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NIFTY UI
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateNiftyUI(){
  const el=document.getElementById('niftyVal'), ar=document.getElementById('niftyArrow');
  if(!niftyPrice){
    el.className='nifty-val flat'; el.textContent='Loading...';
    ar.textContent='â—'; ar.style.color='var(--dim)'; return;
  }
  const dir=niftyPrice>prevNifty?'up':niftyPrice<prevNifty?'down':'flat';
  el.className='nifty-val '+dir; el.textContent=fmt(niftyPrice);
  ar.textContent=dir==='up'?'â–²':dir==='down'?'â–¼':'â—';
  ar.style.color=dir==='up'?'var(--green)':dir==='down'?'var(--red)':'var(--dim)';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// POSITION UI
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updatePositionUI(){
  const empty=document.getElementById('posEmpty'),grid=document.getElementById('posGrid'),badge=document.getElementById('posBadge');
  if(!activePos){empty.style.display='block';grid.classList.add('hidden');badge.classList.add('hidden');return;}
  empty.style.display='none';grid.classList.remove('hidden');badge.classList.remove('hidden');
  const pnl=(niftyPrice-activePos.entry_price)*(activePos.quantity||getQty());
  const R=activePos.entry_price-activePos.initial_sl;
  const rr=R>0?((niftyPrice-activePos.entry_price)/R).toFixed(2):'â€”';
  grid.innerHTML=`
    <div><div class="pos-lbl">Symbol</div><div class="pos-val">${activePos.symbol||instrument+' ATM CE'}</div></div>
    <div><div class="pos-lbl">Entry</div><div class="pos-val">â‚¹${fmt(activePos.entry_price)}</div></div>
    <div><div class="pos-lbl">Initial SL</div><div class="pos-val" style="color:var(--red)">â‚¹${fmt(activePos.initial_sl)}</div></div>
    <div><div class="pos-lbl">Current SL</div><div class="pos-val" style="color:var(--yellow)">â‚¹${fmt(activePos.current_sl)}</div></div>
    <div><div class="pos-lbl">LTP</div><div class="pos-val">â‚¹${fmt(niftyPrice)}</div></div>
    <div><div class="pos-lbl">R:R</div><div class="pos-val" style="color:var(--purple)">${rr}</div></div>
    <div><div class="pos-lbl">Quantity</div><div class="pos-val">${activePos.quantity||130}</div></div>
    <div><div class="pos-lbl">Unrealized PNL</div><div class="pos-val" style="color:${pnl>=0?'var(--green)':'var(--red)'}">â‚¹${fmt(pnl)}</div></div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SIGNAL UI
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateSignalUI(){
  const card=document.getElementById('signalCard');
  if(!currentSig){card.classList.add('hidden');return;}
  card.classList.remove('hidden');
  document.getElementById('signalGrid').innerHTML=`
    <div><div class="pos-lbl">Type</div><div class="pos-val" style="color:var(--green)">${currentSig.type||'CE_BUY'}</div></div>
    <div><div class="pos-lbl">Buy Price</div><div class="pos-val">â‚¹${fmt(currentSig.buy_price)}</div></div>
    <div><div class="pos-lbl">Initial SL</div><div class="pos-val" style="color:var(--red)">â‚¹${fmt(currentSig.initial_sl)}</div></div>
    <div><div class="pos-lbl">SL Distance</div><div class="pos-val">${fmt(currentSig.sl_distance)} pts</div></div>
    <div><div class="pos-lbl">Signal High</div><div class="pos-val">â‚¹${fmt(currentSig.signal_high)}</div></div>
    <div><div class="pos-lbl">VWAP</div><div class="pos-val" style="color:var(--purple)">â‚¹${fmt(currentSig.vwap)}</div></div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// WEBSOCKET
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function connectWS(){
  if(!WS_URL) return;
  try{
    ws=new WebSocket(WS_URL);
    ws.onopen=()=>{wsConnected=true;document.getElementById('wsDot').className='ws-dot connected';document.getElementById('wsLabel').textContent='Connected';addLog('info','âœ… Connected to backend');};
    ws.onmessage=e=>{try{handleWSMessage(JSON.parse(e.data));}catch(err){}};
    ws.onclose=()=>{wsConnected=false;document.getElementById('wsDot').className='ws-dot disconnected';document.getElementById('wsLabel').textContent='Reconnecting...';setTimeout(connectWS,5000);};
    ws.onerror=()=>ws.close();
  }catch(e){}
}

function handleWSMessage(msg){
  switch(msg.type){
    case 'state_update':
      if(msg.data.nifty_price){prevNifty=niftyPrice;niftyPrice=msg.data.nifty_price;updateNiftyUI();updateATM();}
      if(msg.data.active_position!==undefined){activePos=msg.data.active_position;updatePositionUI();}
      if(msg.data.current_signal!==undefined){currentSig=msg.data.current_signal;updateSignalUI();}
      break;
    case 'signal':   currentSig=msg.data;updateSignalUI();addLog('signal','ğŸ¯ Signal: Buy @ â‚¹'+fmt(msg.data.buy_price));break;
    case 'entry':    activePos=msg.data;updatePositionUI();addLog('entry-c','âœ… Entry @ â‚¹'+fmt(msg.data.entry_price));break;
    case 'sl_update':if(activePos){activePos.current_sl=msg.data.sl;updatePositionUI();addLog('sl','ğŸ“ˆ SL â†’ â‚¹'+fmt(msg.data.sl));}break;
    case 'exit':
      const p=msg.data.pnl;
      addLog(p>=0?'profit':'loss',(p>=0?'ğŸŸ¢':'ğŸ”´')+' Exit @ â‚¹'+fmt(msg.data.exit_price)+' | PNL: â‚¹'+fmt(p)+' | '+msg.data.reason);
      trades.unshift({id:trades.length+1,instrument,time_of_entry:activePos?.time_of_entry||new Date().toISOString(),
        entry_price:activePos?.entry_price,time_of_exit:msg.data.time_of_exit,
        exit_price:msg.data.exit_price,reason_of_exit:msg.data.reason,pnl:p,mode,quantity:tradeQty});
      activePos=null;currentSig=null;updatePositionUI();updateSignalUI();break;
    case 'bot_status':botStatus=msg.status;updateStatusUI();break;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TRADE TABLE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderTradeTable(){
  const dateF=document.getElementById('filterDate').value;
  const modeF=document.getElementById('filterMode').value;
  const instrF=document.getElementById('filterInstr').value;
  const filtered=trades.filter(t=>{
    if(dateF&&!t.time_of_entry.startsWith(dateF)) return false;
    if(modeF&&t.mode!==modeF) return false;
    if(instrF&&t.instrument!==instrF) return false;
    return true;
  });
  const tbody=document.getElementById('tradeTbody');
  tbody.innerHTML='';
  document.getElementById('noTrades').style.display=filtered.length?'none':'block';
  filtered.forEach(t=>{
    const pnlCls=t.pnl>0?'pnl-pos':t.pnl<0?'pnl-neg':'pnl-zero';
    const instrBadge=t.instrument==='BANKNIFTY'?`<span class="instr-bnk">BNK</span>`:t.instrument==='BTC'?`<span class="instr-btc">BTC</span>`:`<span class="instr-nf">NF</span>`;
    if(editingId===t.id){
      tbody.innerHTML+=`<tr style="background:#0a1520">
        <td>${t.id}</td><td>${instrBadge}</td>
        <td><input class="cell-inp" id="e_et" value="${(t.time_of_entry||'').slice(0,16)}" type="datetime-local" style="min-width:145px"/></td>
        <td><input class="cell-inp" id="e_ep" value="${t.entry_price||''}" type="number" step="0.25" style="min-width:75px"/></td>
        <td style="font-size:11px;font-family:var(--mono)">${fmtD(t.time_of_exit)} ${fmtT(t.time_of_exit)}</td>
        <td><input class="cell-inp" id="e_xp" value="${t.exit_price||''}" type="number" step="0.25" style="min-width:75px"/></td>
        <td><select class="cell-inp" id="e_rsn">${['SL_HIT','TRAILING_SL','VWAP_EXIT','SHOOTING_STAR_EXIT','TIME_EXIT_3_10','SWING_LOW_EXIT','MANUAL_EXIT'].map(r=>`<option${r===t.reason_of_exit?' selected':''}>${r}</option>`).join('')}</select></td>
        <td><span class="${pnlCls}">â‚¹${fmt(t.pnl)}</span></td>
        <td><span class="mode-pill ${(t.mode||'').toLowerCase()}">${t.mode||''}</span></td>
        <td><button class="btn-save" onclick="saveEdit(${t.id})">âœ“</button><button class="btn-cancel-edit" onclick="cancelEdit()">âœ—</button></td>
      </tr>`;
    } else {
      tbody.innerHTML+=`<tr>
        <td>${t.id}</td><td>${instrBadge}</td>
        <td style="font-size:11px;font-family:var(--mono)">${fmtD(t.time_of_entry)} ${fmtT(t.time_of_entry)}</td>
        <td style="font-family:var(--mono)">â‚¹${fmt(t.entry_price)}</td>
        <td style="font-size:11px;font-family:var(--mono)">${fmtD(t.time_of_exit)} ${fmtT(t.time_of_exit)}</td>
        <td style="font-family:var(--mono)">â‚¹${fmt(t.exit_price)}</td>
        <td><span class="reason-badge">${t.reason_of_exit||'â€”'}</span></td>
        <td><span class="${pnlCls}">â‚¹${fmt(t.pnl)}</span></td>
        <td><span class="mode-pill ${(t.mode||'').toLowerCase()}">${t.mode||''}</span></td>
        <td>
          <button class="btn-edit" onclick="startEdit(${t.id})">âœ</button>
          <button class="btn-del-row" onclick="confirmAction('deleteTrade','Delete trade #${t.id}?',${t.id})">ğŸ—‘</button>
        </td>
      </tr>`;
    }
  });
}

function startEdit(id){editingId=id;renderTradeTable();}
function cancelEdit(){editingId=null;renderTradeTable();}
function saveEdit(id){
  const ep=parseFloat(document.getElementById('e_ep').value);
  const xp=parseFloat(document.getElementById('e_xp').value);
  const rsn=document.getElementById('e_rsn').value;
  const qty=trades.find(t=>t.id===id)?.quantity||getQty();
  const pnl=xp?(xp-ep)*qty:null;
  trades=trades.map(t=>t.id===id?{...t,entry_price:ep,exit_price:xp,reason_of_exit:rsn,pnl:pnl?+pnl.toFixed(2):t.pnl}:t);
  editingId=null; renderTradeTable();
  if(wsConnected) fetch(`${BACKEND_URL}/api/trades/${id}`,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify({entry_price:ep,exit_price:xp,reason_of_exit:rsn})}).catch(()=>{});
  showToast('Trade updated');
}

function exportCSV(){
  const headers=['ID','Instrument','Entry Time','Entry Price','Exit Time','Exit Price','Reason','PNL','Mode'];
  const rows=trades.map(t=>[t.id,t.instrument,t.time_of_entry,t.entry_price,t.time_of_exit,t.exit_price,t.reason_of_exit,t.pnl,t.mode]);
  const csv=[headers,...rows].map(r=>r.join(',')).join('\n');
  const a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv'}));
  a.download=`trades_${new Date().toISOString().slice(0,10)}.csv`;
  a.click();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PNL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderPNL(){
  const instrF=document.getElementById('pnlInstrFilter').value;
  const closed=trades.filter(t=>t.pnl!=null&&(!instrF||t.instrument===instrF));
  const totalPNL=closed.reduce((s,t)=>s+(t.pnl||0),0);
  const wins=closed.filter(t=>t.pnl>0),losses=closed.filter(t=>t.pnl<0);
  const winRate=closed.length?(wins.length/closed.length*100).toFixed(1):0;
  const avgWin=wins.length?(wins.reduce((s,t)=>s+t.pnl,0)/wins.length).toFixed(0):0;
  const avgLoss=losses.length?(losses.reduce((s,t)=>s+t.pnl,0)/losses.length).toFixed(0):0;
  const rr=avgLoss?Math.abs(avgWin/avgLoss).toFixed(2):'â€”';
  document.getElementById('statGrid').innerHTML=[
    {l:'Total PNL',v:`â‚¹${fmt(totalPNL)}`,c:totalPNL>=0?'var(--green)':'var(--red)'},
    {l:'Total Trades',v:closed.length,c:'var(--text)'},
    {l:'Win Rate',v:`${winRate}%`,c:'var(--yellow)'},
    {l:'Avg Win',v:`â‚¹${fmt(avgWin)}`,c:'var(--green)'},
    {l:'Avg Loss',v:`â‚¹${fmt(avgLoss)}`,c:'var(--red)'},
    {l:'Avg R:R',v:rr,c:'var(--purple)'},
  ].map(s=>`<div class="stat-card"><div class="stat-lbl">${s.l}</div><div class="stat-val" style="color:${s.c}">${s.v}</div></div>`).join('');
  const dailyMap={};
  closed.forEach(t=>{const day=t.time_of_entry?.slice(0,10);if(!day)return;if(!dailyMap[day])dailyMap[day]=0;dailyMap[day]+=t.pnl;});
  const days=Object.entries(dailyMap).sort().slice(-30);
  const labels=days.map(([d])=>new Date(d).toLocaleDateString('en-IN',{day:'2-digit',month:'short'}));
  const values=days.map(([,v])=>+v.toFixed(2));
  if(pnlChartInst) pnlChartInst.destroy();
  pnlChartInst=new Chart(document.getElementById('pnlChart').getContext('2d'),{
    type:'bar',
    data:{labels,datasets:[{label:'Daily PNL',data:values,backgroundColor:values.map(v=>v>=0?'rgba(0,255,157,0.7)':'rgba(255,107,107,0.7)'),borderRadius:4}]},
    options:{responsive:true,maintainAspectRatio:false,
      plugins:{legend:{display:false},tooltip:{callbacks:{label:c=>`â‚¹${fmt(c.raw)}`}}},
      scales:{x:{ticks:{color:'#555',font:{size:10}},grid:{color:'#1a2230'},border:{color:'#1a2230'}},
              y:{ticks:{color:'#555',font:{size:10},callback:v=>`â‚¹${(v/1000).toFixed(0)}k`},grid:{color:'#1a2230'},border:{color:'#1a2230'}}}}
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SETTINGS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function saveSettings(){
  const url=document.getElementById('s_backendUrl').value.trim().replace(/\/$/,'');
  if(url){BACKEND_URL=url;WS_URL=url.replace('https','wss').replace('http','ws')+'/ws';localStorage.setItem('backendUrl',url);connectWS();loadTradesFromBackend();}
  showToast('Settings saved');
  addLog('info','âš™ Settings saved. Backend: '+(url||'Demo mode'));
}
async function loadTradesFromBackend(){
  if(!BACKEND_URL) return;
  try{const r=await fetch(`${BACKEND_URL}/api/trades`);const d=await r.json();if(Array.isArray(d)&&d.length){trades=d;renderTradeTable();}}catch(e){}
}

let candleHistory = []; // last 20 five-min candles

function calcEMA(prices, period) {
  if(prices.length < period) return null;
  const k = 2/(period+1);
  let ema = prices.slice(0,period).reduce((a,b)=>a+b,0)/period;
  for(let i=period;i<prices.length;i++) ema = prices[i]*k + ema*(1-k);
  return +ema.toFixed(2);
}

function calcVWAP(candles) {
  let cumTPV=0, cumVol=0;
  candles.forEach(c=>{ const tp=(c.h+c.l+c.c)/3; cumTPV+=tp*(c.v||1); cumVol+=(c.v||1); });
  return cumVol>0 ? +(cumTPV/cumVol).toFixed(2) : null;
}

function detectCandlePattern(o,h,l,c) {
  const body=Math.abs(c-o), range=h-l;
  if(range===0) return '';
  const upperWick=h-Math.max(o,c), lowerWick=Math.min(o,c)-l;
  if(upperWick>body*2 && body<range*0.3) return 'ğŸŒ  Shooting Star';
  if(lowerWick>body*2 && body<range*0.3) return 'ğŸ”¨ Hammer';
  if(body>range*0.7 && c>o) return 'ğŸŸ¢ Bullish Marubozu';
  if(body>range*0.7 && c<o) return 'ğŸ”´ Bearish Marubozu';
  if(body<range*0.1) return 'ã€°ï¸ Doji';
  return '';
}

// â”€â”€ LIVE PRICE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Uses multiple sources tried in order:
// 1. api.frankfurter.app style: open-cors finance APIs
// 2. Mboum Finance (free, CORS-open, no key needed)  
// 3. Fallback static values from known last close
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

const TICKER_MAP = {
  NIFTY:     { yf: '%5ENSEI',    name: 'NIFTY 50',   fallback: 25571.35, isCrypto: false },
  BANKNIFTY: { yf: '%5ENSEBANK', name: 'NIFTY BANK', fallback: 54467.35, isCrypto: false },
  BTC:       { yf: 'BTC-USD',    name: 'Bitcoin',    fallback: 95000.00, isCrypto: true  }
};

// We use jsonp-style fetching via a <script> tag to bypass CORS entirely
let _priceCallbackMap = {};
window._priceCallback = function(sym, data) {
  if(_priceCallbackMap[sym]) _priceCallbackMap[sym](data);
};

function fetchPriceJSONP(url, callbackParam, sym) {
  return new Promise((resolve, reject) => {
    const cbName = '_priceCallback_' + sym + '_' + Date.now();
    window[cbName] = (data) => { resolve(data); cleanup(); };
    const t = setTimeout(() => { reject(new Error('timeout')); cleanup(); }, 6000);
    const script = document.createElement('script');
    const sep = url.includes('?') ? '&' : '?';
    script.src = url + sep + callbackParam + '=' + cbName;
    script.onerror = () => { reject(new Error('script error')); cleanup(); };
    document.head.appendChild(script);
    function cleanup() { clearTimeout(t); script.remove(); delete window[cbName]; }
  });
}

async function safeFetch(url, timeoutMs=6000) {
  const ctrl = new AbortController();
  const t = setTimeout(() => ctrl.abort(), timeoutMs);
  try {
    const r = await fetch(url, {
      signal: ctrl.signal,
      headers: { 'Accept': 'application/json', 'Content-Type': 'application/json' }
    });
    clearTimeout(t);
    if(!r.ok) throw new Error('HTTP ' + r.status);
    return await r.json();
  } catch(e) { clearTimeout(t); throw e; }
}

async function fetchRealPrice() {
  if(sleeping) return; // halted in sleep mode
  const cfg = TICKER_MAP[instrument];

  const setStatus = (txt, col, anim) => {
    const b = document.getElementById('marketStatusBadge');
    if(!b) return;
    b.textContent = txt; b.style.color = col;
    b.style.animation = anim ? 'pulse 1.5s infinite' : 'none';
  };
  const setTime = t => {
    const el = document.getElementById('lastUpdateTime');
    if(el) el.textContent = t;
  };
  const applyPrice = (d) => {
    if(!d || !d.ltp || d.ltp < 0.01) return false;
    prevNifty  = niftyPrice || d.ltp;
    niftyPrice = +d.ltp.toFixed(2);
    updateNiftyUI(); updateATM();
    updateMarketPanel(d);
    const now3 = new Date();
    const timeStr = now3.toLocaleTimeString('en-IN',{hour:'2-digit',minute:'2-digit',second:'2-digit'});
    const isWknd = isWeekendIST();
    const cfg2 = TICKER_MAP[instrument];
    if(cfg2.isCrypto || isMarketOpen()) {
      const ist = getIST();
      const istStr = ist.toLocaleTimeString('en-IN',{hour:'2-digit',minute:'2-digit',second:'2-digit'});
      setTime((cfg2.isCrypto ? 'Live UTC ' : 'Live IST ') + istStr);
      setStatus('â— LIVE', 'var(--green)', true);
    } else if(isWknd) {
      setTime('Weekend Â· Fri close Â· ' + timeStr);
      setStatus('â— MARKET CLOSED', 'var(--yellow)', false);
    } else {
      setTime('Market closed Â· last close Â· ' + timeStr);
      setStatus('â— MARKET CLOSED', 'var(--yellow)', false);
    }
    return true;
  };

  // â”€â”€ Source 1: Mboum Finance API (free, proper CORS headers) â”€â”€
  try {
    const url = `https://mboum-finance.p.rapidapi.com/qu/quote/?symbol=${cfg.mboum}`;
    const data = await safeFetch(url, 5000);
    const q = Array.isArray(data) ? data[0] : data;
    if(q && q.regularMarketPrice > 100) {
      if(applyPrice({
        ltp:q.regularMarketPrice, high:q.regularMarketDayHigh,
        low:q.regularMarketDayLow, prev:q.regularMarketPreviousClose,
        open:q.regularMarketOpen, chg:q.regularMarketChange,
        chgPct:q.regularMarketChangePercent
      })) return;
    }
  } catch(e) {}

  // â”€â”€ Source 2: Yahoo Finance via multiple CORS proxies â”€â”€
  const proxyList = [
    u => `https://api.allorigins.win/raw?url=${encodeURIComponent(u)}`,
    u => `https://corsproxy.io/?${encodeURIComponent(u)}`,
    u => `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(u)}`,
    u => `https://proxy.cors.sh/${u}`,
  ];
  // Live hours: 1m interval, 1d range for freshest tick
  // After hours / weekend: 5m interval, 5d range to get last session candles
  // BTC: always 1m/1d (24/7 market)
  const cfg3 = TICKER_MAP[instrument];
  const mktNowOpen = cfg3.isCrypto ? true : isMarketOpen();
  const interval3  = mktNowOpen ? '1m' : '5m';
  const range3     = mktNowOpen ? '1d' : '5d';
  const yahooUrl = `https://query2.finance.yahoo.com/v8/finance/chart/${cfg.yf}?interval=${interval3}&range=${range3}&includePrePost=false`;

  for(const makeProxy of proxyList) {
    try {
      const purl = makeProxy(yahooUrl);
      const ctrl = new AbortController();
      const t = setTimeout(() => ctrl.abort(), 7000);
      const r = await fetch(purl, { signal: ctrl.signal });
      clearTimeout(t);
      if(!r.ok) continue;
      const text = await r.text();
      let data;
      try { data = JSON.parse(text); } catch(e) { continue; }
      // Some proxies wrap: {contents: '...'}
      if(data.contents) { try { data = JSON.parse(data.contents); } catch(e) { continue; } }
      const res = data?.chart?.result?.[0];
      if(!res) continue;
      const meta = res.meta;
      const ltp  = meta.regularMarketPrice || meta.previousClose;
      if(ltp > 100) {
        // Try to get candle data too
        const q = res.indicators?.quote?.[0];
        if(q && res.timestamp) {
          candleHistory = [];
          for(let i = 0; i < res.timestamp.length; i++) {
            if(q.close[i] != null && q.close[i] > 100)
              candleHistory.push({ o:q.open[i], h:q.high[i], l:q.low[i], c:q.close[i], v:q.volume[i]||0 });
          }
          if(candleHistory.length) updateCandlePanel();
        }
        if(applyPrice({
          ltp, high:meta.regularMarketDayHigh||ltp, low:meta.regularMarketDayLow||ltp,
          prev:meta.previousClose||ltp, open:meta.regularMarketOpen||ltp,
          chg:(ltp-(meta.previousClose||ltp)), chgPct:meta.regularMarketChangePercent||0
        })) return;
      }
    } catch(e) { /* next proxy */ }
  }

  // â”€â”€ Source 3: Last known close (guaranteed fallback) â”€â”€
  if(niftyPrice === 0) {
    const fb = cfg.fallback;
    prevNifty = fb; niftyPrice = fb;
    updateNiftyUI(); updateATM();
    updateMarketPanel({ ltp:fb, high:fb, low:fb, prev:fb, open:fb, chg:0, chgPct:0 });
  }
  // Show appropriate status â€” don't call it "offline" if market is just closed
  const isWeekend = isWeekendIST();
  if(isWeekend) {
    setTime('Weekend â€” showing Friday close');
    setStatus('â— MARKET CLOSED', 'var(--yellow)', false);
  } else if(!isMarketOpen()) {
    setTime('Market closed â€” showing last close');
    setStatus('â— MARKET CLOSED', 'var(--yellow)', false);
  } else {
    setTime('Live feed unavailable â€” showing last close');
    setStatus('â— DELAYED', 'var(--yellow)', false);
  }
}
function updateMarketPanel(d) {
  const pnlCol = d.chg>=0?'var(--green)':'var(--red)';
  const chgSign = d.chg>=0?'+':'';
  document.getElementById('mv_ltp').textContent  = fmt(d.ltp);
  document.getElementById('mv_ltp').style.color  = pnlCol;
  document.getElementById('mv_chg').textContent  = chgSign+fmt(d.chg)+' ('+chgSign+(d.chgPct||0).toFixed(2)+'%)';
  document.getElementById('mv_chg').style.color  = pnlCol;
  document.getElementById('mv_high').textContent = fmt(d.high);
  document.getElementById('mv_low').textContent  = fmt(d.low);
  document.getElementById('mv_prev').textContent = fmt(d.prev);
  document.getElementById('mv_open').textContent = fmt(d.open);
}

function updateCandlePanel() {
  if(!candleHistory.length) return;
  const closes = candleHistory.map(c=>c.c);
  const ema21  = calcEMA(closes, 21);
  const ema34  = calcEMA(closes, 34);
  const vwap   = calcVWAP(candleHistory);
  const last   = candleHistory[candleHistory.length-1];

  document.getElementById('mv_ema21').textContent = ema21 ? fmt(ema21) : 'â€”';
  document.getElementById('mv_ema34').textContent = ema34 ? fmt(ema34) : 'â€”';
  document.getElementById('mv_vwap').textContent  = vwap  ? fmt(vwap)  : 'â€”';

  // EMA crossover signal
  const sig = document.getElementById('mv_ema_sig');
  if(ema21&&ema34) {
    if(ema21>ema34) { sig.textContent='ğŸŸ¢ EMA21 > EMA34 (Bullish)'; sig.style.color='var(--green)'; }
    else            { sig.textContent='ğŸ”´ EMA21 < EMA34 (Bearish)'; sig.style.color='var(--red)'; }
  }

  // Last candle OHLC
  if(last) {
    document.getElementById('c_open').textContent  = fmt(last.o);
    document.getElementById('c_high').textContent  = fmt(last.h);
    document.getElementById('c_low').textContent   = fmt(last.l);
    document.getElementById('c_close').textContent = fmt(last.c);
    document.getElementById('c_close').style.color = last.c>=last.o?'var(--green)':'var(--red)';
    document.getElementById('candlePattern').textContent = detectCandlePattern(last.o,last.h,last.l,last.c);
  }

  // Sparkline bars
  renderSparkline(candleHistory.slice(-20));

  // Push EMA/VWAP to position card if active
  if(activePos) { activePos._ema21=ema21; activePos._ema34=ema34; activePos._vwap=vwap; }
}

function renderSparkline(candles) {
  const wrap = document.getElementById('sparkBars');
  if(!candles.length) return;
  wrap.innerHTML='';
  const allH=candles.map(c=>c.h), allL=candles.map(c=>c.l);
  const maxH=Math.max(...allH), minL=Math.min(...allL), range=maxH-minL||1;
  candles.forEach(c=>{
    const bar=document.createElement('div');
    bar.className='spark-bar';
    const pct=((c.c-minL)/range*100);
    bar.style.height=Math.max(4,pct)+'%';
    bar.style.background=c.c>=c.o?'var(--green)':'var(--red)';
    bar.style.opacity='0.7';
    bar.title=`O:${fmt(c.o)} H:${fmt(c.h)} L:${fmt(c.l)} C:${fmt(c.c)}`;
    wrap.appendChild(bar);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DEMO SIMULATION (trading events only â€” no fake price walk)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function runDemoSim(){
  simTick++;
  // Price comes from fetchRealPrice(), not random walk
  // Trading sim only fires when market open AND bot RUNNING
  if(isSleeping || botStatus!=='RUNNING') return; // halted in sleep or not running

  if(!activePos&&!currentSig&&Math.random()>.97&&niftyPrice>1000){
    currentSig={type:'CE_BUY',buy_price:+(niftyPrice+2).toFixed(2),initial_sl:+(niftyPrice-15).toFixed(2),sl_distance:17,signal_high:niftyPrice,signal_low:+(niftyPrice-16).toFixed(2),vwap:+(niftyPrice-5).toFixed(2)};
    updateSignalUI();
    addLog('signal',`ğŸ¯ ${instrument} Signal: Buy @ â‚¹${fmt(currentSig.buy_price)} | SL: â‚¹${fmt(currentSig.initial_sl)}`);
  }
  if(currentSig&&!activePos&&Math.random()>.75&&niftyPrice>1000){
    const qty=getQty();
    activePos={symbol:`${instrument} ATM CE`,entry_price:currentSig.buy_price,initial_sl:currentSig.initial_sl,current_sl:currentSig.initial_sl,signal_high:currentSig.signal_high,quantity:qty,mode,instrument,time_of_entry:new Date().toISOString()};
    currentSig=null; updatePositionUI(); updateSignalUI();
    addLog('entry-c',`âœ… Entry: ${instrument} ATM CE @ â‚¹${fmt(activePos.entry_price)} | Qty: ${qty}`);
  }
  if(activePos){
    const R=activePos.entry_price-activePos.initial_sl, profit=niftyPrice-activePos.entry_price, rr=R>0?profit/R:0;
    if(rr>=1){const newSL=Math.max(activePos.current_sl,activePos.entry_price+(rr>=2?R*(rr-1)-3:0));if(newSL>activePos.current_sl){activePos.current_sl=+newSL.toFixed(2);addLog('sl',`ğŸ“ˆ SL trailed â†’ â‚¹${fmt(activePos.current_sl)}`);}}
    updatePositionUI();
    if(Math.random()>.98){
      const reason=['SL_HIT','TRAILING_SL','VWAP_EXIT','TIME_EXIT_3_10'][Math.floor(Math.random()*4)];
      const pnl=+((niftyPrice-activePos.entry_price)*tradeQty).toFixed(2);
      trades.unshift({id:trades.length+1,instrument,time_of_entry:activePos.time_of_entry,entry_price:activePos.entry_price,time_of_exit:new Date().toISOString(),exit_price:niftyPrice,reason_of_exit:reason,pnl,mode,quantity:tradeQty});
      addLog(pnl>=0?'profit':'loss',`${pnl>=0?'ğŸŸ¢':'ğŸ”´'} Exit @ â‚¹${fmt(niftyPrice)} | PNL: â‚¹${fmt(pnl)} | ${reason}`);
      activePos=null; updatePositionUI();
    }
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// QUANTITY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getQty(){
  return parseInt(document.getElementById('tradeQty').value)||1;
}

function onQtyChange(){
  const cfg = INSTRUMENTS[instrument];
  const qty = getQty();
  const lots = cfg.lotSize ? (qty/cfg.lotSize).toFixed(2) : 'â€”';
  const lotsStr = cfg.lotSize && qty % cfg.lotSize === 0
    ? `= ${qty/cfg.lotSize} lot${qty/cfg.lotSize!==1?'s':''}`
    : `â‰ˆ ${lots} lots`;
  document.getElementById('lotLabel').textContent = lotsStr;
  // save per instrument
  localStorage.setItem('qty_'+instrument, qty);
}

function setDefaultQty(){
  const cfg = INSTRUMENTS[instrument];
  const saved = localStorage.getItem('qty_'+instrument);
  const qty = saved ? parseInt(saved) : cfg.lotSize;
  document.getElementById('tradeQty').value = qty;
  onQtyChange();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// THEME
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleTheme(){
  const isLight = document.body.classList.toggle('light');
  document.getElementById('themeToggleBtn').textContent = isLight ? 'â˜€ï¸' : 'ğŸŒ™';
  localStorage.setItem('theme', isLight ? 'light' : 'dark');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.addEventListener('DOMContentLoaded',()=>{
  // Restore theme
  if(localStorage.getItem('theme')==='light'){
    document.body.classList.add('light');
    document.getElementById('themeToggleBtn').textContent='â˜€ï¸';
  }
  // Restore theme
  const savedTheme = localStorage.getItem('theme');
  if(savedTheme === 'light') { isDarkTheme=false; document.body.classList.add('light'); document.getElementById('themeToggleBtn').textContent='â˜€ï¸'; }
  const saved=localStorage.getItem('backendUrl');
  if(saved){document.getElementById('s_backendUrl').value=saved;BACKEND_URL=saved;WS_URL=saved.replace('https','wss').replace('http','ws')+'/ws';}
  updateNiftyUI(); updateATM(); updateStatusUI(); updatePositionUI(); updateSignalUI();
  addLog('info','System initialized Â· Paper mode Â· 21/34 EMA strategy');
  addLog('info',`Market ${isMarketOpen()?'OPEN ğŸŸ¢':'CLOSED ğŸ”´ (chart shows last session)'}`);
  addLog('info','Select instrument â†’ Start bot to begin scanning');
  activePos = null; currentSig = null; // clear any stale state
  updatePositionUI(); updateSignalUI();
  if(WS_URL){connectWS();loadTradesFromBackend();}
  setDefaultQty(); // set qty input based on instrument defaults
  // Fetch real last close / live price immediately, then every 15s
  fetchRealPrice();
  setInterval(fetchRealPrice, 8000); // every 8s
  // Trading sim (does not touch price)
  setInterval(runDemoSim, 3000);
});
</script>
</body>
</html>
